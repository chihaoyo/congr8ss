<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>法律提案・congr8ss</title>
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:500,700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <nav>
    <div id="sitename">congr8ss</div>
  </nav>
  <header>
    <h1>法律提案</h1>
  </header>
</body>
<script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>
<script src="js/util.js"></script>
<script src="js/Proposal.js"></script>
<script src="js/Meeting.js"></script>
<script>

var meetings = [];
var meetingDictionary = {};
var meetingTimeDictionary = {};

var proposals = [];
var proposalDictionaryByBills = {};

var main = function() {
  console.log(proposals.length, 'proposals');
  console.log(Utility.unique(proposals, 'status'));
  console.log(Utility.unique(proposals, 'bills').length, 'unique bills');

  var $body = $('body');

  // build dictionaries of meetings
  for(var meeting of meetings) {
    // meetingDictionary
    var idString = meeting.id.numericID;
    if(meetingDictionary[idString] == undefined) {
      meetingDictionary[idString] = {};
    }
    if(meetingDictionary[idString][meeting.name] == undefined) {
      meetingDictionary[idString][meeting.name] = [];
    }
    meetingDictionary[idString][meeting.name].push(meeting.date + 'T' + meeting.time.start + '-' + meeting.time.finish);

    // meetingTimeDictionary
    var timeString = meeting.time.start + '-' + meeting.time.finish;
    if(meetingTimeDictionary[timeString] == undefined)
      meetingTimeDictionary[timeString] = [];
    meetingTimeDictionary[timeString].push(meeting.date + ':' + meeting.name);
  }
  meetingTimeDictionary = Utility.sortObjectByKey(meetingTimeDictionary);

  // build dictionaries of proposals
  for(var proposal of proposals) {
    proposal.lookupDictionaries();
  }

  // plain output
  /*
  var $table = $('<table id="proposals">').appendTo($('body'));
  for(var i = 0; i < proposals.length; i++) {
    $table.append(proposals[i].toRow(i + 1));
  }*/

  // group proposals by bills
  for(var proposal of proposals) {
    var bills = proposal.bills.join(',');
    proposalDictionaryByBills[bills] = (proposalDictionaryByBills[bills] == undefined ? [] : proposalDictionaryByBills[bills]);
    proposalDictionaryByBills[bills].push(proposal);
  }
  proposalDictionaryByBills = Utility.sortObjectByKey(proposalDictionaryByBills);

  for(var bills of Object.keys(proposalDictionaryByBills)) {
    var $section = $('<section>').append('<h1>' + bills + '</h1>')
    var $table = $('<table class="proposals">');
    var proposalsOfBills = proposalDictionaryByBills[bills];
    for(var i = 0; i < proposalsOfBills.length; i++) {
      $table.append(proposalsOfBills[i].toRow(i + 1));
    }
    $section.append($table);
    $body.append($section);
  }
}; // end of main()

// load everything in
// proposals: http://data.ly.gov.tw/getds.action?id=20
// meetings: http://data.ly.gov.tw/getds.action?id=42
var Q = queue(1);
for(var i = 1; i <= 3; i++) {
  Q.defer(Meeting.loader, 'meetings/p' + i + '.xml'); // JSON is unavailable
}
for(var i = 1; i <= 14; i++) {
  Q.defer(Proposal.loader, 'proposals/p' + i + '.json');
}
Q.awaitAll(main);

</script>
</html>
