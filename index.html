<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>法律提案・congr8ss</title>
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:500,700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="css/style.css"/>
</head>
<body class="colors sectionTitles">
  <nav>
    <div id="siteName">congr8ss</div>
    <div id="partyFilter"></div>
    <div id="statusFilter"></div>
    <div id="layout">
      <input type="checkbox" id="colors" checked/><label for="colors">colors</label>
      <input type="checkbox" id="sectionTitles" checked/><label for="sectionTitles">sectionTitles</label>
      <input type="checkbox" id="dataOnly"/><label for="dataOnly">dataOnly</label>
    </div>
  </nav>
  <header>
    <h1>法律提案</h1>
    <label id="loading">讀取中⋯</label>
  </header>
</body>
<script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>
<script src="js/util.js"></script>
<script src="js/Proposer.js"></script>
<script src="js/Meeting.js"></script>
<script src="js/Proposal.js"></script>
<script>

var $body, $progrssBar, $partyFilter, $statusFilter, $layout;

var proposers = {};

var meetings = [];
var meetingDictionary = {};
var meetingTimeDictionary = {};

var proposals = {};
var proposalDictionaryByBill = {};
var proposalDictionaryByRequest = {};

$(function() {
  $body = $('body');
  $partyFilter = $('#partyFilter');
  $statusFilter = $('#statusFilter');
  $layout = $('#layout');

  for(var party in Utility.PARTYCODE) {
    $('<input type="checkbox" id="' + party + '" checked/>').change(function() {
      var $this = $(this);
      $('tr[data-parties~="' + $this.attr('id') + '"]').toggle($this.prop('checked'));
    }).add('<label for="' + party + '">' + Utility.PARTYCODE[party] + '</label>').appendTo($partyFilter);
  }
  for(var status in Utility.STATUSCODE) {
    $('<input type="checkbox" id="' + status + '" checked/>').change(function() {
      var $this = $(this);
      $('tr[data-status="' + $this.attr('id') + '"]').toggle($this.prop('checked'));
    }).add('<label for="' + status + '">' + Utility.STATUSCODE[status] + '</label>').appendTo($statusFilter);
  }
  $('#colors, #sectionTitles, #dataOnly').click(function() {
    $body.toggleClass($(this).attr('id'), $(this).prop('checked'));
  });
});

var main = function() {
  console.log(Object.keys(proposals).length, 'proposals');
  var BILLS = Utility.unique(proposals, 'bills').sort();
  console.log(BILLS.length, 'unique bills', BILLS);

  // build dictionaries of meetings
  for(var meeting of meetings) {
    // meetingDictionary
    var idString = meeting.id.numericID;
    if(meetingDictionary[idString] == undefined) {
      meetingDictionary[idString] = {};
    }
    if(meetingDictionary[idString][meeting.name] == undefined) {
      meetingDictionary[idString][meeting.name] = [];
    }
    meetingDictionary[idString][meeting.name].push(meeting.date + 'T' + meeting.time.start + '-' + meeting.time.finish);

    // meetingTimeDictionary
    var timeString = meeting.time.start + '-' + meeting.time.finish;
    if(meetingTimeDictionary[timeString] == undefined)
      meetingTimeDictionary[timeString] = [];
    meetingTimeDictionary[timeString].push(meeting.date + ':' + meeting.name);
  }
  meetingTimeDictionary = Utility.sortObjectByKey(meetingTimeDictionary);

  // augement proposals with meeting data
  for(var pid in proposals) {
    proposals[pid].lookupMeetings();
  }

  // plain output
  /*
  var $table = $('<table id="proposals">').appendTo($('body'));
  for(var i = 0; i < proposals.length; i++) {
    $table.append(proposals[i].toRow(i + 1));
  }*/

  // group proposals by bills
  /*
  for(var proposal of proposals) {
    var bills = proposal.bills.join(',');
    proposalDictionaryByBill[bills] = (proposalDictionaryByBill[bills] == undefined ? [] : proposalDictionaryByBill[bills]);
    proposalDictionaryByBill[bills].push(proposal);
  }
  proposalDictionaryByBill = Utility.sortObjectByKey(proposalDictionaryByBill);
  Utility.printProposalsInSection(proposalDictionaryByBill);
  */

  // group proposals by requests
  for(var pid in proposals) {
    var proposal = proposals[pid];
    var requests = [];
    for(var bill in proposal.requests) {
      var detailItems = proposal.requests[bill];
      for(item of detailItems) {
        requests.push(bill + ':' + item);
      }
    }
    for(request of requests) {
      proposalDictionaryByRequest[request] = (proposalDictionaryByRequest[request] == undefined ? [] : proposalDictionaryByRequest[request]);
      proposalDictionaryByRequest[request].push(proposal.id);
    }
  }
  proposalDictionaryByRequest = Utility.sortObjectByKey(proposalDictionaryByRequest);
  Utility.printProposalsInSection(proposalDictionaryByRequest);

  var REQUESTS = Object.keys(proposalDictionaryByRequest);
  console.log(REQUESTS.length, 'unique requests', REQUESTS);

  $('#loading').remove();
}; // end of main()

// load everything in
// proposals: http://data.ly.gov.tw/getds.action?id=20
// meetings: http://data.ly.gov.tw/getds.action?id=42
var Q = queue(1); // parallelism: sequential
Q.defer(Proposer.loader, 'legislators/p1.xml');
for(var i = 1; i <= 3; i++) {
  Q.defer(Meeting.loader, 'meetings/p' + i + '.xml'); // JSON is unavailable
}
for(var i = 1; i <= 14; i++) {
  Q.defer(Proposal.loader, 'proposals/p' + i + '.json');
}
Q.awaitAll(main);

</script>
</html>
